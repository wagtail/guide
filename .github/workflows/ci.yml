name: CI

on:
  push:
  pull_request:

jobs:
  test:
    name: ðŸ“‹ Test
    runs-on: ubuntu-latest

    env:
      DJANGO_SETTINGS_MODULE: apps.guide.settings.test
      DATABASE_URL: postgres://postgres:postgres@localhost/postgres # pragma: allowlist secret
      SECRET_KEY: iamnotsosecret
      ALLOWED_HOSTS: localhost

    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres # pragma: allowlist secret
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5

    steps:
      - uses: actions/checkout@v6
      - run: pipx install "poetry>=2.2.1,<3"
      - uses: actions/setup-python@v5
        with:
          python-version: 3.11
          cache: poetry
      - run: poetry install --no-root
      - run: poetry run python manage.py check
      - run: poetry run python manage.py collectstatic --noinput --clear
      - run: poetry run python manage.py createcachetable
      - run: poetry run python manage.py makemigrations --check
      - run: mkdir ./apps/frontend/static && echo "{}" > ./apps/frontend/static/manifest.json
      - run: make test-coverage

  check_python:
    name: ðŸ Check Python (backend)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6
      - run: pipx install "poetry>=2.2.1,<3"
      - uses: actions/setup-python@v5
        with:
          python-version: 3.11
          cache: poetry
      - run: poetry install --no-root
      - run: make lint-backend

  check_node:
    name: ðŸ‘©â€ðŸš€ Check Node (frontend)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
      - run: npm ci
      - run: npm run build
      - run: npm run lint
